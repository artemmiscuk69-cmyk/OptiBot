<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OptiBotX PRO</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        /* --- –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–∏–∑ —Ç–≤–æ–µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–¥–∞) --- */
        :root {
            --bg-color: #050510;
            --app-bg: #0b0b1a;
            --border-color: #1a1a2e;
            --text-color: white;
            --secondary-bg: #161625;
            --hover-color: #2a2a3f;
            --accent: #5b4dff;
            --accent-glow: rgba(91, 77, 255, 0.3);
            --glass-bg: rgba(20, 30, 50, 0.6);
            --glass-border: rgba(255, 255, 255, 0.15);
        }
        body.light-theme {
            --bg-color: #f0f2f5;
            --app-bg: #ffffff;
            --border-color: #ddd;
            --text-color: #222;
            --secondary-bg: #f5f5f5;
            --hover-color: #e0e0e0;
            --accent: #3f51b5;
            --accent-glow: rgba(63, 81, 181, 0.3);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
        }
        body {
            margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color);
            font-family: 'Segoe UI', sans-serif; height: 100vh; 
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- –°–¢–ï–ö–õ–Ø–ù–ù–´–ô –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø --- */
        .welcome-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s;
            backdrop-filter: blur(10px);
        }
        .welcome-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .welcome-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            padding: 30px 20px;
            width: 80%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9);
            animation: glassAppear 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            transition: transform 0.3s;
        }
        @keyframes glassAppear {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .welcome-title {
            font-size: 2.2rem;
            font-weight: 800;
            margin: 0 0 10px;
            background: linear-gradient(135deg, #fff, #aaccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(91,77,255,0.5);
        }
        .welcome-subtitle {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 25px;
        }
        .language-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }
        .language-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 14px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .language-item:hover {
            background: rgba(255,255,255,0.15);
            transform: scale(1.02);
            box-shadow: 0 0 20px var(--accent-glow);
        }
        .language-item.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 0 30px var(--accent-glow);
        }
        .language-item .flag {
            font-size: 1.8rem;
        }
        .start-btn {
            background: var(--accent);
            border: none;
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            padding: 16px 30px;
            border-radius: 40px;
            cursor: pointer;
            box-shadow: 0 0 30px var(--accent-glow);
            transition: all 0.3s;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            width: 100%;
        }
        .start-btn.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px var(--accent-glow);
        }

        /* --- –ü–ï–†–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø - –í–í–û–î UID) --- */
        .register-step1-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .register-step1-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .register-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            padding: 30px 20px;
            width: 80%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9);
            animation: glassAppear 0.4s forwards;
        }
        .register-glass h3 {
            margin-top: 0;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #fff, #aaccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .register-glass p {
            font-size: 1rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .register-input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            color: var(--text-color);
            font-size: 1rem;
            text-align: center;
            margin-bottom: 15px;
            outline: none;
            box-sizing: border-box;
        }
        .register-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }
        .next-btn {
            background: var(--accent);
            border: none;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 40px;
            cursor: pointer;
            width: 100%;
            transition: 0.3s;
            box-shadow: 0 0 20px var(--accent-glow);
            margin-bottom: 10px;
        }
        .next-btn:hover {
            transform: scale(1.05);
        }
        .next-btn:disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .step1-message {
            font-size: 0.9rem;
            min-height: 20px;
            color: var(--accent-green);
        }
        .step1-message.error {
            color: #ff4d4d;
        }

        /* --- –í–¢–û–†–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–î–ï–ü–û–ó–ò–¢ - –û–ñ–ò–î–ê–ù–ò–ï) --- */
        .register-step2-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .register-step2-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .register-step2-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            padding: 30px 20px;
            width: 80%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9);
            animation: glassAppear 0.4s forwards;
        }
        .register-step2-glass h3 {
            margin-top: 0;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #fff, #aaccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .register-step2-glass p {
            font-size: 1rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .step2-ref-link {
            color: var(--accent);
            text-decoration: underline;
            word-break: break-all;
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: block;
        }
        .close-btn {
            background: var(--accent);
            border: none;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 40px;
            cursor: pointer;
            width: 100%;
            transition: 0.3s;
            box-shadow: 0 0 20px var(--accent-glow);
            margin-bottom: 10px;
        }
        .close-btn:hover {
            transform: scale(1.05);
        }
        .step2-message {
            font-size: 0.9rem;
            min-height: 20px;
            color: #ffaa00;
            margin-top: 10px;
        }

        /* --- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
        .app-container {
            width: 100%; max-width: 400px; height: 98vh; background: var(--app-bg);
            display: none;
            flex-direction: column; padding: 15px; box-sizing: border-box;
            position: relative; border: 1px solid var(--border-color); border-radius: 12px;
            animation: fadeInScale 0.5s ease-out;
            transition: background 0.3s, border-color 0.3s;
        }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .logo h1 { font-size: 18px; margin: 0; color: var(--text-color); animation: glowPulse 2s infinite; }
        .logo span { color: var(--accent); font-weight: 800; text-shadow: 0 0 8px var(--accent); }
        .header-buttons { display: flex; gap: 5px; }
        .icon-btn { 
            background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-color); 
            padding: 5px 8px; border-radius: 6px; cursor: pointer; font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .icon-btn:hover { background: var(--hover-color); transform: scale(1.05); }

        /* --- –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ü–û–ò–°–ö–ê –ò –ü–ê–† --- */
        .selector-container {
            position: relative;
            margin-bottom: 10px;
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #8899ac;
            font-size: 16px;
            pointer-events: none;
            z-index: 2;
        }
        #pair-search {
            width: 100%;
            background: var(--secondary-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 12px 12px 40px;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
            transition: all 0.3s;
            margin-bottom: 8px;
        }
        #pair-search:focus {
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }
        #pair-search::placeholder {
            color: #8899ac;
            font-size: 14px;
        }
        .pairs-container {
            max-height: 250px;
            overflow-y: auto;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 5px 0;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--secondary-bg);
            display: none;
            will-change: transform, opacity;
        }
        .pairs-container::-webkit-scrollbar {
            width: 6px;
        }
        .pairs-container::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: 10px;
        }
        .pairs-container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }
        .pair-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .pair-option:last-child {
            border-bottom: none;
        }
        .pair-option:hover {
            background: var(--hover-color);
        }
        .pair-option.selected {
            background: var(--accent);
            color: white;
        }
        .pair-option .pair-flag {
            font-size: 1.2rem;
            min-width: 24px;
            text-align: center;
        }
        .pair-option .pair-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
        }
        .pair-option .pair-type {
            font-size: 10px;
            color: #8899ac;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .pair-option.selected .pair-type {
            color: white;
            background: rgba(255,255,255,0.2);
        }

        /* —Å—Ç–∞—Ä—ã–π select —Å–∫—Ä—ã–≤–∞–µ–º */
        #pair {
            display: none;
        }

        /* --- –ì–†–ê–§–ò–ö --- */
        .chart-container {
            position: relative;
            width: 100%; height: 280px; margin-bottom: 15px;
        }
        .chart-box { 
            width: 100%; height: 100%; background: var(--app-bg); 
            border-radius: 10px; border: 1px solid var(--border-color);
            position: relative; overflow: hidden;
            transition: box-shadow 0.3s;
        }
        .chart-box:hover { box-shadow: 0 0 20px var(--accent-glow); }
        #mainChart { width: 100%; height: 100%; display: block; }
        .chart-controls {
            position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 10;
        }
        .chart-controls button {
            background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-color);
            width: 30px; height: 30px; border-radius: 15px; cursor: pointer; font-weight: bold;
            transition: all 0.3s;
        }
        .chart-controls button:hover { background: var(--accent); color: white; }

        .tf-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 8px; }
        
        .tf-btn, .analyze-btn {
            will-change: transform;
        }
        .tf-btn { 
            background: var(--secondary-bg); border: 1px solid var(--border-color); color: #666; 
            padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer; 
            transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        
        .tf-btn:hover {
            transform: scale(1.1);
            background: var(--hover-color);
            color: var(--text-color);
            border-color: var(--accent);
            z-index: 10;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .tf-btn.active { 
            background: var(--accent); color: white; border-color: var(--accent); 
            box-shadow: 0 0 15px var(--accent-glow);
            animation: pulse 1.5s infinite;
        }
        .tf-btn.active:hover { transform: scale(1.1); background: var(--accent); }

        .analyze-btn { 
            width: 100%; background: var(--accent); border: none; padding: 16px; border-radius: 12px; 
            color: white; font-weight: bold; cursor: pointer; font-size: 16px; margin: 10px 0;
            transition: all 0.3s; position: relative; overflow: hidden;
        }
        .analyze-btn:hover { 
            background: var(--accent); transform: translateY(-2px); box-shadow: 0 10px 20px var(--accent-glow);
        }
        .analyze-btn:active { transform: translateY(0); }
        .analyze-btn.loading {
            pointer-events: none; opacity: 0.8;
        }
        .analyze-btn.loading::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            margin-top: -10px; margin-left: -10px; border: 2px solid transparent; border-top-color: white;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        .analyze-btn.loading span {
            opacity: 0;
        }

        .status-area { 
            display: flex; justify-content: center; align-items: center; gap: 10px; height: 30px; margin-bottom: 10px;
            animation: fadeIn 0.5s;
        }
        .dot { 
            width: 12px; height: 12px; background: #2575fc; border-radius: 50%; 
            box-shadow: 0 0 10px #2575fc;
            animation: pulseDot 1.2s infinite;
            will-change: transform;
        }
        
        .result-display { 
            width: 100%;
            height: 50px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            line-height: 50px;
            margin-bottom: 10px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            box-sizing: border-box;
            will-change: opacity, transform;
        }
        .result-display.visible {
            opacity: 1;
            visibility: visible;
        }

        #snow-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 1000; 
            transition: opacity 0.3s;
        }
        #tooltip {
            position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px;
            border-radius: 4px; font-size: 10px; pointer-events: none; z-index: 1001;
            display: none;
        }
        .indicator-btn {
            background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-color);
            padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;
            transition: all 0.3s; margin-right: 5px;
        }
        .indicator-btn.active { background: var(--accent); color: white; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeInScale { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--accent-glow); } 70% { box-shadow: 0 0 0 10px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }
        @keyframes pulseDot { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes glowPulse { 0% { text-shadow: 0 0 2px var(--accent); } 50% { text-shadow: 0 0 15px var(--accent), 0 0 30px var(--accent); } 100% { text-shadow: 0 0 2px var(--accent); } }
        @keyframes ripple { 0% { transform: scale(0, 0); opacity: 1; } 20% { transform: scale(25, 25); opacity: 1; } 100% { opacity: 0; transform: scale(40, 40); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-5px); } 40%,80% { transform: translateX(5px); } }

        .chart-box::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 30% 50%, rgba(91, 77, 255, 0.05), transparent 50%);
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="welcome-overlay" class="welcome-overlay visible">
    <div class="welcome-glass">
        <h1 class="welcome-title">Welcome</h1>
        <p class="welcome-subtitle">Choose your language</p>
        <div class="language-list">
            <div class="language-item" data-lang="en"><span class="flag">üá¨üáß</span> English</div>
            <div class="language-item" data-lang="ru"><span class="flag">üá∑üá∫</span> –†—É—Å—Å–∫–∏–π</div>
            <div class="language-item" data-lang="pl"><span class="flag">üáµüá±</span> Polski</div>
            <div class="language-item" data-lang="de"><span class="flag">üá©üá™</span> Deutsch</div>
            <div class="language-item" data-lang="fr"><span class="flag">üá´üá∑</span> Fran√ßais</div>
        </div>
        <button id="start-btn" class="start-btn">Start</button>
    </div>
</div>

<!-- –ü–ï–†–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø - –í–í–û–î UID) -->
<div id="register-step1-overlay" class="register-step1-overlay">
    <div class="register-glass">
        <h3 id="step1-title">üîê Registration</h3>
        <p id="step1-text">Enter your Pocket Option UID to proceed:</p>
        <input type="text" id="step1-uid-input" class="register-input" placeholder="Enter your UID">
        <button id="step1-next-btn" class="next-btn">Next ‚Üí</button>
        <div id="step1-message" class="step1-message"></div>
    </div>
</div>

<!-- –í–¢–û–†–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–î–ï–ü–û–ó–ò–¢ - –û–ñ–ò–î–ê–ù–ò–ï) -->
<div id="register-step2-overlay" class="register-step2-overlay">
    <div class="register-step2-glass">
        <h3 id="step2-title">üí∞ Deposit</h3>
        <p id="step2-text">Make a deposit (min. $10) using the same link, then wait for confirmation.</p>
        <a id="step2-ref-link" class="step2-ref-link" href="#" target="_blank">üîó Referral link</a>
        <button id="step2-close-btn" class="close-btn">Close</button>
        <div id="step2-message" class="step2-message">‚è≥ Waiting for deposit confirmation...</div>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
<div class="app-container" id="main-app" style="display: none;">
    <canvas id="snow-layer"></canvas>
    <div id="tooltip"></div>

    <header>
        <div class="logo">
            <h1>AI OptiBotX <span>PRO</span></h1>
            <div id="sub-header" style="font-size: 10px; color: #444;">–í—ã–±–µ—Ä–∏ –≤–∞–ª—é—Ç–Ω—É—é –ø–∞—Ä—É</div>
        </div>
        <div class="header-buttons">
            <button id="themeBtn" class="icon-btn" onclick="toggleTheme()">üåì</button>
            <button id="snowToggle" class="icon-btn" onclick="toggleSnow()">‚òÉÔ∏è</button>
            <button id="langBtn" class="icon-btn">üá¨üáß EN</button>
        </div>
    </header>

    <!-- –ü–æ–∏—Å–∫ –∏ —Å–ø–∏—Å–æ–∫ –ø–∞—Ä -->
    <div class="selector-container">
        <span class="search-icon">üîç</span>
        <input type="text" id="pair-search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–∞—Ä—ã (EUR, USD, OTC...)">
        <div class="pairs-container" id="pairs-container"></div>
    </div>
    <select id="pair" onchange="changePair()" style="display: none;"></select>

    <!-- –ì—Ä–∞—Ñ–∏–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="chart-container">
        <div class="chart-box"><canvas id="mainChart"></canvas></div>
        <div class="chart-controls">
            <button onclick="zoomOut()">‚àí</button>
            <button onclick="zoomIn()">+</button>
        </div>
        <div style="position: absolute; bottom: 5px; left: 5px; display: flex; gap: 5px;">
            <button id="smaBtn" class="indicator-btn" onclick="toggleSMA()">SMA 7</button>
        </div>
    </div>

    <div class="tf-grid">
        <button class="tf-btn" onclick="selectTf(this)">5s</button>
        <button class="tf-btn" onclick="selectTf(this)">10s</button>
        <button class="tf-btn" onclick="selectTf(this)">15s</button>
        <button class="tf-btn" onclick="selectTf(this)">30s</button>
        <button class="tf-btn active" onclick="selectTf(this)">1m</button>
        <button class="tf-btn" onclick="selectTf(this)">2m</button>
        <button class="tf-btn" onclick="selectTf(this)">5m</button>
        <button class="tf-btn" onclick="selectTf(this)">15m</button>
    </div>

    <button id="anBtn" class="analyze-btn" onclick="startAnalysis(this)"><span>–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</span></button>

    <div id="status" class="status-area">
        <div class="dot"></div> <span id="wait-msg">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
    </div>

    <div id="result" class="result-display"></div>
</div>

<script>
    // Firebase config (–ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ apiKey –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–ª—è optibotx-486b7)
    const firebaseConfig = {
        apiKey: "AIzaSyBlL7xhbnITKkhpUipqdbJOmN4TG2rXbtY",
        databaseURL: "https://optibotx-486b7-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const canvas = document.getElementById('mainChart');
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    let candles = [];
    let smaData = [];
    let showSMA = false;
    let candleCount = 14;
    let snowEnabled = false;
    let curLang = 'en';
    let touchStartX = 0;
    let touchEndX = 0;
    let registered = false;
    let userId = null;

    // –°–ª–æ–≤–∞—Ä—å —è–∑—ã–∫–æ–≤ (–¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –¥–≤—É—Ö –æ–∫–æ–Ω)
    const dict = {
        en: { 
            sub: "Select currency pair", 
            an: "Analyze", 
            wait: "Waiting...", 
            up: "BUY ", 
            down: "SELL ",
            welcome: "Welcome",
            chooseLang: "Choose your language",
            flag: "üá¨üáß",
            step1Title: "üîê Registration",
            step1Text: "Enter your Pocket Option UID to proceed:",
            step1Placeholder: "Enter your UID",
            step1Next: "Next ‚Üí",
            step1Error: "Please enter a valid UID.",
            step1Success: "UID saved. Now make a deposit.",
            step2Title: "üí∞ Deposit",
            step2Text: "Make a deposit (min. $10) using the same link, then wait for confirmation.",
            step2Close: "Close",
            step2Waiting: "‚è≥ Waiting for deposit confirmation...",
            refLink: "üîó Referral link"
        },
        ru: { 
            sub: "–í—ã–±–µ—Ä–∏ –≤–∞–ª—é—Ç–Ω—É—é –ø–∞—Ä—É", 
            an: "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å", 
            wait: "–û–∂–∏–¥–∞–Ω–∏–µ...", 
            up: "–í–í–ï–†–• ", 
            down: "–í–ù–ò–ó ",
            welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
            chooseLang: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫",
            flag: "üá∑üá∫",
            step1Title: "üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
            step1Text: "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à UID –∏–∑ Pocket Option –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è:",
            step1Placeholder: "–í–≤–µ–¥–∏—Ç–µ UID",
            step1Next: "–î–∞–ª–µ–µ ‚Üí",
            step1Error: "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π UID.",
            step1Success: "UID —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –¢–µ–ø–µ—Ä—å —Å–¥–µ–ª–∞–π—Ç–µ –¥–µ–ø–æ–∑–∏—Ç.",
            step2Title: "üí∞ –î–µ–ø–æ–∑–∏—Ç",
            step2Text: "–°–¥–µ–ª–∞–π—Ç–µ –¥–µ–ø–æ–∑–∏—Ç (–º–∏–Ω. $10) –ø–æ —Ç–æ–π –∂–µ —Å—Å—ã–ª–∫–µ –∏ –æ–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
            step2Close: "–ó–∞–∫—Ä—ã—Ç—å",
            step2Waiting: "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞...",
            refLink: "üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞"
        },
        pl: {
            sub: "Wybierz parƒô walutowƒÖ",
            an: "Analizuj",
            wait: "Oczekiwanie...",
            up: "W G√ìRƒò ",
            down: "W D√ì≈Å ",
            welcome: "Witaj",
            chooseLang: "Wybierz jƒôzyk",
            flag: "üáµüá±",
            step1Title: "üîê Rejestracja",
            step1Text: "Wprowad≈∫ sw√≥j UID z Pocket Option, aby kontynuowaƒá:",
            step1Placeholder: "Wprowad≈∫ UID",
            step1Next: "Dalej ‚Üí",
            step1Error: "Wprowad≈∫ poprawny UID.",
            step1Success: "UID zapisany. Teraz dokonaj depozytu.",
            step2Title: "üí∞ Depozyt",
            step2Text: "Wp≈Çaƒá depozyt (min. $10) u≈ºywajƒÖc tego samego linku i czekaj na potwierdzenie.",
            step2Close: "Zamknij",
            step2Waiting: "‚è≥ Oczekiwanie na potwierdzenie depozytu...",
            refLink: "üîó Link partnerski"
        },
        de: {
            sub: "W√§hrungspaar ausw√§hlen",
            an: "Analysieren",
            wait: "Warten...",
            up: "KAUFEN ",
            down: "VERKAUFEN ",
            welcome: "Willkommen",
            chooseLang: "Sprache w√§hlen",
            flag: "üá©üá™",
            step1Title: "üîê Registrierung",
            step1Text: "Geben Sie Ihre Pocket Option UID ein, um fortzufahren:",
            step1Placeholder: "UID eingeben",
            step1Next: "Weiter ‚Üí",
            step1Error: "Geben Sie eine g√ºltige UID ein.",
            step1Success: "UID gespeichert. T√§tigen Sie jetzt eine Einzahlung.",
            step2Title: "üí∞ Einzahlung",
            step2Text: "T√§tigen Sie eine Einzahlung (min. $10) mit demselben Link und warten Sie auf Best√§tigung.",
            step2Close: "Schlie√üen",
            step2Waiting: "‚è≥ Warte auf Einzahlungsbest√§tigung...",
            refLink: "üîó Partnerlink"
        },
        fr: {
            sub: "Choisir une paire de devises",
            an: "Analyser",
            wait: "Attente...",
            up: "ACHAT ",
            down: "VENTE ",
            welcome: "Bienvenue",
            chooseLang: "Choisissez la langue",
            flag: "üá´üá∑",
            step1Title: "üîê Inscription",
            step1Text: "Entrez votre UID Pocket Option pour continuer :",
            step1Placeholder: "Entrez votre UID",
            step1Next: "Suivant ‚Üí",
            step1Error: "Veuillez entrer un UID valide.",
            step1Success: "UID enregistr√©. Effectuez maintenant un d√©p√¥t.",
            step2Title: "üí∞ D√©p√¥t",
            step2Text: "Effectuez un d√©p√¥t (min. $10) en utilisant le m√™me lien et attendez la confirmation.",
            step2Close: "Fermer",
            step2Waiting: "‚è≥ En attente de confirmation du d√©p√¥t...",
            refLink: "üîó Lien de parrainage"
        }
    };

    // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
    const welcomeOverlay = document.getElementById('welcome-overlay');
    const startBtn = document.getElementById('start-btn');
    const langItems = document.querySelectorAll('.language-item');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –æ–∫–Ω–∞
    const step1Overlay = document.getElementById('register-step1-overlay');
    const step1Title = document.getElementById('step1-title');
    const step1Text = document.getElementById('step1-text');
    const step1UidInput = document.getElementById('step1-uid-input');
    const step1NextBtn = document.getElementById('step1-next-btn');
    const step1Message = document.getElementById('step1-message');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –≤—Ç–æ—Ä–æ–≥–æ –æ–∫–Ω–∞
    const step2Overlay = document.getElementById('register-step2-overlay');
    const step2Title = document.getElementById('step2-title');
    const step2Text = document.getElementById('step2-text');
    const step2RefLink = document.getElementById('step2-ref-link');
    const step2CloseBtn = document.getElementById('step2-close-btn');
    const step2Message = document.getElementById('step2-message');

    const pairsContainer = document.getElementById('pairs-container');
    const searchInput = document.getElementById('pair-search');
    const hiddenSelect = document.getElementById('pair');

    // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–∞—Ä (–≤—Å—Ç–∞–≤—å —Å–≤–æ–π –ø–æ–ª–Ω—ã–π –º–∞—Å—Å–∏–≤, —è –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ—Å—Ç–∞–≤–ª—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –Ω–æ –≤ —Ç–≤–æ—ë–º –∫–æ–¥–µ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å)
    const allPairs = [ /* ... —Ç–≤–æ–π –æ–≥—Ä–æ–º–Ω—ã–π —Å–ø–∏—Å–æ–∫ ... */ ];

    // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å Firebase
    async function getUserStatus() {
        if (!userId) return false;
        const snapshot = await database.ref('users/' + userId).once('value');
        const data = snapshot.val();
        return data?.registered || false;
    }

    async function saveUid(uid) {
        if (!userId) return;
        await database.ref('users/' + userId).set({
            registered: false,
            uid: uid,
            requestedAt: Date.now()
        });
    }

    // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞
    function setupRegistrationListener() {
        if (!userId) return;
        database.ref('users/' + userId).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.registered === true) {
                registered = true;
                step1Overlay.classList.remove('visible');
                step2Overlay.classList.remove('visible');
                console.log('‚úÖ –î–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
            }
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ Next (–ø–µ—Ä–≤–æ–µ –æ–∫–Ω–æ)
    step1NextBtn.addEventListener('click', async () => {
        const uid = step1UidInput.value.trim();
        if (!uid || uid.length < 3) {
            step1Message.innerText = dict[curLang].step1Error;
            step1Message.classList.add('error');
            return;
        }
        step1NextBtn.disabled = true;
        step1Message.innerText = '‚è≥ Saving...';
        step1Message.classList.remove('error');
        await saveUid(uid);
        step1Message.innerText = dict[curLang].step1Success;
        step1Message.classList.remove('error');
        step1NextBtn.disabled = false;
        // –ü–µ—Ä–µ—Ö–æ–¥ –∫–æ –≤—Ç–æ—Ä–æ–º—É –æ–∫–Ω—É
        step1Overlay.classList.remove('visible');
        step2Overlay.classList.add('visible');
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ Close (–≤—Ç–æ—Ä–æ–µ –æ–∫–Ω–æ) ‚Äì –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ, –Ω–µ –º–µ–Ω—è—è —Å—Ç–∞—Ç—É—Å
    step2CloseBtn.addEventListener('click', () => {
        step2Overlay.classList.remove('visible');
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏
    langItems.forEach(item => {
        item.addEventListener('click', () => {
            langItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            const lang = item.dataset.lang;
            curLang = lang;
            startBtn.classList.add('visible');
            document.querySelector('.welcome-title').innerText = dict[lang].welcome;
            document.querySelector('.welcome-subtitle').innerText = dict[lang].chooseLang;
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ Start
    startBtn.addEventListener('click', async () => {
        welcomeOverlay.classList.remove('visible');
        const app = document.getElementById('main-app');
        app.style.display = 'flex';

        // –ü–æ–ª—É—á–∞–µ–º Telegram ID (–∏–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–π)
        if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
            userId = window.Telegram.WebApp.initDataUnsafe.user.id.toString();
        } else {
            userId = 'test_user_' + Math.random().toString(36).substr(2, 9);
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É —Å click_id
        const REF_LINK = `https://u3.shortink.io/register?utm_campaign=822097&utm_source=affiliate&utm_medium=sr&a=TNOv4heF82mMb6&ac=osnova&code=EDS965&click_id=${userId}`;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
        registered = await getUserStatus();

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞—Ä
        allPairs.forEach(p => {
            const option = document.createElement('option');
            option.value = p.name;
            option.text = p.name;
            hiddenSelect.appendChild(option);
        });
        if (allPairs.length > 0) {
            hiddenSelect.value = allPairs[0].name;
        }
        renderPairs();
        initChart();
        setupSnow();
        updateUILang();

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –≤–æ –≤—Ç–æ—Ä–æ–º –æ–∫–Ω–µ
        step2RefLink.href = REF_LINK;
        step2RefLink.innerText = dict[curLang].refLink;

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å
        setupRegistrationListener();

        // –ï—Å–ª–∏ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –æ–∫–Ω–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        if (registered) return;
        // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –æ–∫–Ω–æ
        step1Overlay.classList.add('visible');
    });

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–µ–π—Å—Ç–≤–∏—è
    function requireRegistration() {
        if (!registered) {
            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å false, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –æ–∫–Ω–æ (–µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –≤–∏–¥–Ω–æ)
            if (!step1Overlay.classList.contains('visible') && !step2Overlay.classList.contains('visible')) {
                step1Overlay.classList.add('visible');
            }
            return true;
        }
        return false;
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    const originalStartAnalysis = window.startAnalysis;
    window.startAnalysis = function(btn) {
        if (requireRegistration()) return;
        originalStartAnalysis(btn);
    };

    const originalSelectTf = window.selectTf;
    window.selectTf = function(btn) {
        if (requireRegistration()) return;
        originalSelectTf(btn);
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
    };

    const originalChangePair = window.changePair;
    window.changePair = function() {
        if (requireRegistration()) return;
        originalChangePair();
    };

    const originalToggleSMA = window.toggleSMA;
    window.toggleSMA = function() {
        if (requireRegistration()) return;
        originalToggleSMA();
    };

    const originalZoomIn = window.zoomIn;
    window.zoomIn = function() {
        if (requireRegistration()) return;
        originalZoomIn();
    };

    const originalZoomOut = window.zoomOut;
    window.zoomOut = function() {
        if (requireRegistration()) return;
        originalZoomOut();
    };

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é —Å–ø–∏—Å–∫–∞ –ø–∞—Ä
    searchInput.addEventListener('focus', () => {
        pairsContainer.style.display = 'block';
    });
    searchInput.addEventListener('blur', () => {
        setTimeout(() => {
            if (!pairsContainer.contains(document.activeElement)) {
                pairsContainer.style.display = 'none';
            }
        }, 200);
    });

    function renderPairs(filter = '') {
        const filterLower = filter.toLowerCase();
        const filtered = allPairs.filter(p => 
            p.name.toLowerCase().includes(filterLower) || 
            p.type.toLowerCase().includes(filterLower)
        );
        
        pairsContainer.innerHTML = '';
        filtered.forEach(pair => {
            const div = document.createElement('div');
            div.className = 'pair-option';
            if (pair.name === hiddenSelect.value) {
                div.classList.add('selected');
            }
            div.innerHTML = `
                <span class="pair-flag">${pair.flag}</span>
                <span class="pair-name">${pair.name}</span>
                <span class="pair-type">${pair.type}</span>
            `;
            div.addEventListener('click', () => {
                document.querySelectorAll('.pair-option').forEach(el => el.classList.remove('selected'));
                div.classList.add('selected');
                hiddenSelect.value = pair.name;
                changePair();
                pairsContainer.style.display = 'none';
                searchInput.blur();
            });
            pairsContainer.appendChild(div);
        });

        if (filtered.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'pair-option';
            empty.style.justifyContent = 'center';
            empty.style.padding = '20px';
            empty.innerText = '‚ùå Nothing found';
            pairsContainer.appendChild(empty);
        }
    }

    searchInput.addEventListener('input', (e) => {
        renderPairs(e.target.value);
    });

    // --- –°–Ω–µ–≥ ---
    const sCanvas = document.getElementById('snow-layer');
    const sCtx = sCanvas.getContext('2d');
    let flakes = [];
    let snowAnimation;

    function setupSnow() {
        sCanvas.width = sCanvas.parentElement.clientWidth;
        sCanvas.height = sCanvas.parentElement.clientHeight;
        flakes = Array.from({length: 60}, () => ({
            x: Math.random()*sCanvas.width, y: Math.random()*sCanvas.height, r: Math.random()*3+1, d: Math.random()*1+0.5, angle: Math.random()*360
        }));
        if (snowAnimation) cancelAnimationFrame(snowAnimation);
        drawSnow();
    }

    function drawSnow() {
        if (!snowEnabled) {
            sCtx.clearRect(0,0,sCanvas.width, sCanvas.height);
            snowAnimation = requestAnimationFrame(drawSnow);
            return;
        }
        sCtx.clearRect(0,0,sCanvas.width, sCanvas.height);
        sCtx.fillStyle = "rgba(255,255,255,0.6)";
        flakes.forEach(f => {
            sCtx.save();
            sCtx.translate(f.x, f.y);
            sCtx.rotate(f.angle * Math.PI/180);
            sCtx.beginPath(); sCtx.arc(0, 0, f.r, 0, Math.PI*2); sCtx.fill();
            sCtx.restore();
            f.y += f.d; f.x += Math.sin(f.angle) * 0.2;
            if(f.y > sCanvas.height) { f.y = -5; f.x = Math.random()*sCanvas.width; }
            if(f.x > sCanvas.width) f.x = 0; if(f.x < 0) f.x = sCanvas.width;
        });
        snowAnimation = requestAnimationFrame(drawSnow);
    }

    function toggleSnow() {
        snowEnabled = !snowEnabled;
        document.getElementById('snowToggle').innerText = snowEnabled ? '‚ùÑÔ∏è' : '‚òÉÔ∏è';
    }

    function toggleTheme() {
        document.body.classList.toggle('light-theme');
    }

    document.getElementById('langBtn').onclick = function() {
        const langs = ['en', 'ru', 'pl', 'de', 'fr'];
        let idx = langs.indexOf(curLang);
        idx = (idx + 1) % langs.length;
        curLang = langs[idx];
        this.innerHTML = `${dict[curLang].flag} ${curLang.toUpperCase()}`;
        updateUILang();
    };

    function updateUILang() {
        document.getElementById('sub-header').innerText = dict[curLang].sub;
        document.getElementById('anBtn').innerHTML = `<span>${dict[curLang].an}</span>`;
        document.getElementById('wait-msg').innerText = dict[curLang].wait;
        document.getElementById('pair-search').placeholder = dict[curLang].sub;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –≤ –æ–∫–Ω–∞—Ö
        step1Title.innerText = dict[curLang].step1Title;
        step1Text.innerText = dict[curLang].step1Text;
        step1UidInput.placeholder = dict[curLang].step1Placeholder;
        step1NextBtn.innerText = dict[curLang].step1Next;
        step2Title.innerText = dict[curLang].step2Title;
        step2Text.innerText = dict[curLang].step2Text;
        step2CloseBtn.innerText = dict[curLang].step2Close;
        step2Message.innerText = dict[curLang].step2Waiting;
        step2RefLink.innerText = dict[curLang].refLink;
    }

    // --- –ì—Ä–∞—Ñ–∏–∫ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function setupCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
    }

    function initChart() {
        setupCanvas(); candles = [];
        let price = 100;
        for(let i=0; i<candleCount; i++) { 
            let open = price;
            let close = price + (Math.random() - 0.5) * 15;
            candles.push({ 
                open, close, 
                high: Math.max(open, close) + Math.random()*5 + 3, 
                low: Math.min(open, close) - Math.random()*5 - 3,
                progress: 1
            });
            price = close;
        }
        calculateSMA();
        render();
    }

    function calculateSMA(period = 7) {
        smaData = [];
        for (let i = period-1; i < candles.length; i++) {
            let sum = 0;
            for (let j = i-period+1; j <= i; j++) sum += candles[j].close;
            smaData.push({ index: i, value: sum/period });
        }
    }

    function drawGrid(w, h, minP, maxP) {
        ctx.strokeStyle = "#1e1e2f";
        ctx.lineWidth = 0.5;
        const levels = 5;
        for (let i = 0; i <= levels; i++) {
            let y = h * 0.15 + (h * 0.7 / levels) * i;
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y);
            ctx.strokeStyle = document.body.classList.contains('light-theme') ? "#ccc" : "#1e1e2f";
            ctx.stroke();
            let price = maxP - (i / levels) * (maxP - minP);
            ctx.fillStyle = "#666"; ctx.font = "8px 'Segoe UI'";
            ctx.fillText(price.toFixed(2), 5, y-2);
        }
        for (let i = 1; i < candles.length; i++) {
            let x = (i / candles.length) * w;
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h);
            ctx.strokeStyle = document.body.classList.contains('light-theme') ? "#ddd" : "#1a1a2a";
            ctx.stroke();
        }
    }

    function render() {
        const w = canvas.width / dpr; const h = canvas.height / dpr;
        ctx.clearRect(0,0, w, h);
        const allPrices = candles.flatMap(c => [c.high, c.low]);
        const minP = Math.min(...allPrices); const maxP = Math.max(...allPrices);
        const range = (maxP - minP) || 10;
        const getY = (p) => h - ((p - minP) / range) * (h * 0.7) - (h * 0.15);

        drawGrid(w, h, minP, maxP);

        const candleWidth = w / candles.length;
        candles.forEach((c, i) => {
            const x = i * candleWidth + (candleWidth * 0.15);
            const isUp = c.close >= c.open;
            const color = isUp ? '#00ff88' : '#ff4d4d';
            
            ctx.strokeStyle = color; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(x + (candleWidth * 0.35), getY(c.high)); ctx.lineTo(x + (candleWidth * 0.35), getY(c.low)); ctx.stroke();

            let openY = getY(c.open);
            let closeY = getY(c.close);
            let bodyY, bodyH;
            if (isUp) {
                let currentCloseY = openY - (openY - closeY) * c.progress;
                bodyY = currentCloseY; bodyH = openY - currentCloseY;
            } else {
                let currentCloseY = openY + (closeY - openY) * c.progress;
                bodyY = openY; bodyH = currentCloseY - openY;
            }
            if (c.progress > 0 && bodyH > 0.5) {
                ctx.fillStyle = color;
                ctx.beginPath();
                let rectX = x, rectY = bodyY, rectW = candleWidth * 0.7, rectH = bodyH, radius = 2;
                ctx.moveTo(rectX + radius, rectY); ctx.lineTo(rectX + rectW - radius, rectY);
                ctx.quadraticCurveTo(rectX + rectW, rectY, rectX + rectW, rectY + radius);
                ctx.lineTo(rectX + rectW, rectY + rectH - radius);
                ctx.quadraticCurveTo(rectX + rectW, rectY + rectH, rectX + rectW - radius, rectY + rectH);
                ctx.lineTo(rectX + radius, rectY + rectH);
                ctx.quadraticCurveTo(rectX, rectY + rectH, rectX, rectY + rectH - radius);
                ctx.lineTo(rectX, rectY + radius);
                ctx.quadraticCurveTo(rectX, rectY, rectX + radius, rectY);
                ctx.closePath(); ctx.fill();
            }
        });

        if (showSMA && smaData.length > 1) {
            ctx.beginPath(); ctx.strokeStyle = '#ffaa00'; ctx.lineWidth = 2;
            smaData.forEach((pt, idx) => {
                let x = (pt.index / candles.length) * w + candleWidth/2;
                let y = getY(pt.value);
                if (idx === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }
    }

    setInterval(() => {
        if(candles.length === 0) return;
        candles.shift();
        let last = candles[candles.length-1];
        let nO = last.close;
        let nC = nO + (Math.random() - 0.5) * 8;
        let newCandle = { 
            open: nO, close: nC, 
            high: Math.max(nO, nC) + Math.random()*4 + 2, 
            low: Math.min(nO, nC) - Math.random()*4 - 2,
            progress: 0 
        };
        candles.push(newCandle);
        calculateSMA();
        let progress = 0;
        function animateNew() { progress += 0.05; newCandle.progress = Math.min(progress, 1); render(); if (progress < 1) requestAnimationFrame(animateNew); }
        animateNew();
    }, 3000);

    function zoomIn() {
        if (candleCount > 5) candleCount -= 2;
        initChart();
    }
    function zoomOut() {
        if (candleCount < 30) candleCount += 2;
        initChart();
    }

    function toggleSMA() {
        showSMA = !showSMA;
        document.getElementById('smaBtn').classList.toggle('active', showSMA);
        render();
    }

    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const x = (e.clientX - rect.left) * scaleX / dpr;
        const candleWidth = (canvas.width / dpr) / candles.length;
        const idx = Math.floor(x / candleWidth);
        if (idx >= 0 && idx < candles.length) {
            const c = candles[idx];
            document.getElementById('tooltip').style.display = 'block';
            document.getElementById('tooltip').style.left = e.pageX + 10 + 'px';
            document.getElementById('tooltip').style.top = e.pageY - 20 + 'px';
            document.getElementById('tooltip').innerHTML = `O: ${c.open.toFixed(2)} H: ${c.high.toFixed(2)} L: ${c.low.toFixed(2)} C: ${c.close.toFixed(2)}`;
        } else {
            document.getElementById('tooltip').style.display = 'none';
        }
    });
    canvas.addEventListener('mouseleave', () => document.getElementById('tooltip').style.display = 'none');

    canvas.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; });
    canvas.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
    });

    function changePair() {
        canvas.style.opacity = '0.3';
        setTimeout(() => {
            initChart();
            canvas.style.opacity = '1';
            document.querySelectorAll('.pair-option').forEach(el => {
                if (el.querySelector('.pair-name')?.innerText === hiddenSelect.value) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }, 500);
    }

    function startAnalysis(btn) {
        const res = document.getElementById('result');
        const stat = document.getElementById('status');
        res.classList.remove('visible');
        stat.style.display = 'flex';
        btn.classList.add('loading');
        
        setTimeout(() => {
            btn.classList.remove('loading');
            stat.style.display = 'none'; 
            res.classList.add('visible');
            const isUp = Math.random() > 0.5;
            res.style.color = isUp ? '#00ff88' : '#ff4d4d';
            res.style.borderColor = isUp ? '#00ff88' : '#ff4d4d';
            let signal = `${dict[curLang][isUp?'up':'down']} (${Math.floor(Math.random()*15+82)}%)`;
            res.innerHTML = signal;
            res.style.animation = 'popIn 0.4s';
            setTimeout(() => res.style.animation = '', 400);

            if (window.Telegram?.WebApp?.HapticFeedback) {
                if (isUp) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                } else {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                }
                window.Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
            }

            confettiEffect(isUp);
        }, 1500);
    }

    function confettiEffect(isUp) {
        console.log('üéâ Confetti', isUp ? 'green' : 'red');
    }

    function selectTf(btn) {
        document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.expand();
    }
</script>
</body>
</html>
</body>
</html>
